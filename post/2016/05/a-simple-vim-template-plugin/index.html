<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#F5F7F9"><title>一个简单的 Vim 文件模板插件 | B-log</title><link rel=stylesheet href=/css/minimalism.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-67524885-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><header><div class=container><h1><a href=/>B-log</a></h1><nav><ul><li>&nbsp;|&nbsp;</li><li><a href=/post/>Post</a></li><li>&nbsp;|&nbsp;</li><li><a href=/about/>About</a></li><li>&nbsp;|&nbsp;</li></ul></nav></div><hr></header><main><article class=post><header><h1>一个简单的 Vim 文件模板插件</h1><ul class=description><li><time>2016-05-11</time></li><li>&nbsp;|</li><li>&nbsp;#Vim</li></ul></header><section class=license><p><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt="Creative Commons License" src=https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png></a><br>This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p></section><section class=post><p>最近尝试了一下在 Vim 中实现一个简单的文件模板功能, 总共只写了 3 个函数就完成了自己的需求,
再次体现出 Vim 强大的可定制性.</p><h1 id=1-创建新文件时自动填入模板>1. 创建新文件时自动填入模板.</h1><h2 id=11-编写一个简单的模板-以-c-语言的模板为例>1.1. 编写一个简单的模板, 以 C 语言的模板为例.</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#75715e>/*
</span><span style=color:#75715e> * File Name: [:VIM_EVAL:]expand(&#39;%:t&#39;)[:END_EVAL:]
</span><span style=color:#75715e> * Author:
</span><span style=color:#75715e> * Created At: [:VIM_EVAL:]strftime(&#39;%Y-%m-%d %H:%M:%S&#39;)[:END_EVAL:]
</span><span style=color:#75715e> * Last Modified: [:VIM_EVAL:]strftime(&#39;%Y-%m-%d %H:%M:%S&#39;)[:END_EVAL:]
</span><span style=color:#75715e> */</span>
<span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>argv) {
    printf(<span style=color:#e6db74>&#34;Hello World</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></div><p>其中使用 <code>[:VIM_EVAL:][:END_EVAL:]</code> 来作为替换变量的标志. 中间的部分会使用 <code>eval()</code> 执行.</p><h2 id=12-在-vimrc-中添加如下函数>1.2. 在 vimrc 中添加如下函数.</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Vim data-lang=Vim><span style=color:#66d9ef>function</span>! <span style=color:#a6e22e>s</span>:<span style=color:#a6e22e>AddFileTemplate</span>(<span style=color:#a6e22e>filetype</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>template</span> = <span style=color:#e6db74>&#39;~/.vim/templates/&#39;</span> . <span style=color:#a6e22e>a</span>:<span style=color:#a6e22e>filetype</span> . <span style=color:#e6db74>&#39;.template&#39;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>writecmd</span> = <span style=color:#e6db74>&#39;0read &#39;</span> . <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>template</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>silent</span>! <span style=color:#a6e22e>execute</span> <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>writecmd</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>exec_line</span> = <span style=color:#e6db74>&#39;1,&#39;</span> . <span style=color:#a6e22e>min</span>([<span style=color:#a6e22e>line</span>(<span style=color:#e6db74>&#39;$&#39;</span>), <span style=color:#ae81ff>10</span>])<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>eval_regex</span> = <span style=color:#e6db74>&#39;\[:VIM_EVAL:\](.+)\[:END_EVAL:\]&#39;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>eval_func</span> = <span style=color:#e6db74>&#39;\=eval(submatch(1))&#39;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>execcmd</span> = <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>exec_line</span> . <span style=color:#e6db74>&#39;s/\v\C&#39;</span> . <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>eval_regex</span> . <span style=color:#e6db74>&#39;/&#39;</span> . <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>eval_func</span> . <span style=color:#e6db74>&#39;/g&#39;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>silent</span>! <span style=color:#a6e22e>execute</span> <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>execcmd</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>endfunction</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>这里假定模板文件是放置在 <code>~/.vim/templates</code> 目录下.</p><h2 id=13-增加-autocmd-当新建文件时自动填入模板>1.3. 增加 autocmd, 当新建文件时自动填入模板.</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Vim data-lang=Vim><span style=color:#a6e22e>autocmd</span> <span style=color:#a6e22e>BufNewFile</span> *.<span style=color:#a6e22e>h</span>,*.<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>call</span> <span style=color:#a6e22e>s</span>:<span style=color:#a6e22e>AddFileTemplate</span>(<span style=color:#e6db74>&#39;c&#39;</span>)<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><h1 id=2-保存文件时自动更新时间戳>2. 保存文件时自动更新时间戳.</h1><h2 id=21-在-vimrc-中添加如下函数>2.1. 在 vimrc 中添加如下函数.</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Vim data-lang=Vim><span style=color:#66d9ef>function</span>! <span style=color:#a6e22e>s</span>:<span style=color:#a6e22e>UpdateFileTemplate</span>()<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>exec_line</span> = <span style=color:#e6db74>&#39;1,&#39;</span> . <span style=color:#a6e22e>min</span>([<span style=color:#a6e22e>line</span>(<span style=color:#e6db74>&#39;$&#39;</span>), <span style=color:#ae81ff>10</span>])<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>modify_regex</span> = <span style=color:#e6db74>&#39;(Last Modified: )@&lt;=([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2})&#39;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>eval_func</span> = <span style=color:#e6db74>&#39;\=eval(&#34;strftime(\&#34;%Y-%m-%d %H:%M:%S\&#34;)&#34;)&#39;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>silent</span>! <span style=color:#a6e22e>normal</span>! <span style=color:#a6e22e>mm</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>silent</span>! <span style=color:#a6e22e>execute</span> <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>exec_line</span> . <span style=color:#e6db74>&#39;s/\v\C&#39;</span> . <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>modify_regex</span> . <span style=color:#e6db74>&#39;/&#39;</span> . <span style=color:#a6e22e>l</span>:<span style=color:#a6e22e>eval_func</span> . <span style=color:#e6db74>&#39;/&#39;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>silent</span>! <span style=color:#a6e22e>normal</span>! &#39;<span style=color:#a6e22e>m</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>silent</span>! <span style=color:#a6e22e>execute</span> <span style=color:#e6db74>&#39;delmarks m&#39;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>silent</span>! <span style=color:#a6e22e>normal</span>! <span style=color:#a6e22e>zz</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>endfunction</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><h2 id=22-增加-autocmd>2.2. 增加 autocmd</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Vim data-lang=Vim><span style=color:#a6e22e>autocmd</span> <span style=color:#a6e22e>BufWritePre</span> *.<span style=color:#a6e22e>h</span>,*.<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>call</span> <span style=color:#a6e22e>s</span>:<span style=color:#a6e22e>UpdateFileTemplate</span>()<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div></section></article></main><footer><hr><div class=container><div class=copyright>&copy;2017-2019 By cissoid.</div><div class=about>Built with <a href=https://gohugo.io>Hugo</a>, using theme <a href=https://github.com/cissoid/hugo-theme-minimalism>Minimalism</a>.</div></div></footer><div id=mask><div id=loading><div></div></div></div><script src=/js/minimalism.js></script></body></html>